#!/bin/bash

# Instruct bash to exit non-zero on common errors
set -euo pipefail

# Run unit tests with coverage report
deno task test-coverage
if [ $? -ne 0 ]; then
  echo "Test coverage generation failed. Aborting commit."
  exit 1
fi

# Stage the coverage report file for commit
git add tests/coverage-report.txt

# Get the current branch name
current_branch=$(git branch --show-current)

# If on the main branch, run additional tests and benchmarks
if [ "$current_branch" = "main" ]; then
  deno task test-integration
  if [ $? -ne 0 ]; then
    echo "Integration tests failed. Aborting commit."
    exit 1
  fi

  deno task benchmark
  if [ $? -ne 0 ]; then
    echo "Benchmark tests failed. Aborting commit."
    exit 1
  fi

  # Stage the benchmark results file for commit
  git add benchmarks/benchmark-results.txt

fi

# allow the commit
exit 0